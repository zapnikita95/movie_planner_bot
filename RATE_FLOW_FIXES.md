# Исправления флоу оценки фильмов

## Проблемы, которые были исправлены:

### 1. Оценки не обрабатывались после выставления оценки
**Проблема:** После оценки фильма, при попытке отправить ссылку на фильм, ссылка сохранялась в `bot_messages`, но не обрабатывалась - бот дальше не работал.

**Причина:** В `handle_rate_list_reply` проверялись множественные состояния, и если пользователь был в любом из них, сообщения пропускались. После оценки состояние не очищалось, и пользователь оставался "заблокированным".

**Исправление:**
- Изменена логика в `handle_rate_list_reply`: для оценок (чистые числа 1-10) сообщения обрабатываются **ВСЕГДА**, независимо от состояний пользователя
- Это позволяет оценивать фильмы в любой момент, даже если пользователь в других состояниях

### 2. Флоу оценки прерывался для фильмов не в базе
**Проблема:** Когда нажимали "Оценить" и ставили оценку не добавленному в базу фильму, флоу оценки прерывался, и дальше бот не работал.

**Причина:** В `rate_film_callback` для фильмов не в базе сохранялся `film_id` в `rating_messages`, но `film_id` был `None`, что приводило к ошибкам в `handle_rating_internal`.

**Исправление:**
- В `rate_film_callback` для фильмов не в базе теперь сохраняется `kp_id` в формате `"kp_id:123"` вместо `film_id`
- В `handle_rating_internal` добавлена логика для обработки `kp_id` из `rating_messages`
- Фильм автоматически добавляется в базу при оценке, если его там нет

### 3. Похожие фильмы не показывались при оценке 9-10
**Проблема:** Для добавленного в базу фильма оценка дошла до конца, но не появились кнопки с похожими фильмами из `get_similars`. Они должны появляться при оценке 9 или 10.

**Причина:** 
- Условие `if rating >= 9` было правильным, но могла быть проблема с определением `is_group` или с получением `kp_id`
- Возможно, `kp_id` не был получен из БД перед отправкой похожих фильмов

**Исправление:**
- Улучшена логика получения `kp_id` из БД - теперь он всегда получается после сохранения оценки
- Добавлено логирование для отладки определения типа чата (`is_group`)
- Улучшена обработка ошибок при получении похожих фильмов
- Добавлено преобразование `kp_id` в `int` для `get_similars` (функция ожидает int)

### 4. Обработка ссылок после оценки
**Проблема:** После оценки фильма, при попытке отправить ссылку на фильм, ссылка сохранялась, но не обрабатывалась.

**Исправление:**
- В `save_movie_message` добавлена проверка: если это реплай на сообщение с оценкой (`rating_messages`), ссылка обрабатывается всегда, даже если пользователь в других состояниях

## Изменения в коде:

### `moviebot/bot/callbacks/series_callbacks.py`:
- Для фильмов не в базе теперь сохраняется `kp_id` в формате `"kp_id:123"` вместо `film_id`

### `moviebot/bot/handlers/text_messages.py`:
- Изменена логика `handle_rate_list_reply`: оценки обрабатываются независимо от состояний
- В `save_movie_message` добавлена проверка реплаев на сообщения с оценками

### `moviebot/bot/handlers/rate.py`:
- Улучшена логика получения `kp_id` из БД после сохранения оценки
- Добавлено логирование для определения типа чата
- Улучшена обработка ошибок при получении похожих фильмов
- Удалено дублирование кода добавления фильма в базу

### `moviebot/scheduler.py`:
- Исправлена ошибка `print_daily_stats` - добавлен импорт

## Результат:

✅ Оценки обрабатываются всегда, независимо от состояний пользователя
✅ Фильмы не в базе корректно добавляются при оценке
✅ Похожие фильмы показываются при оценке 9-10 для личных чатов
✅ Ссылки обрабатываются корректно после оценки
✅ Бот продолжает работать после оценки
