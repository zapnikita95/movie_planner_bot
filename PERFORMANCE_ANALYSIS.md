# Анализ производительности операций "Открыть описание фильма"

## Проблема

Операции типа "Открыть описание фильма" или "Вернуться к описанию" занимают слишком много времени, что приводит к 499 ошибкам (timeout).

## Что происходит при нажатии кнопки "Вернуться к описанию"

### Последовательность операций в `back_to_film_description`:

1. ✅ `bot.answer_callback_query()` - **быстро** (< 100ms)
2. ⚠️ Запрос к БД для получения `is_series` и `link` - **быстро** (~50ms)
3. ❌ **`extract_movie_info(link)`** - **МЕДЛЕННО** (1-3 секунды):
   - Запрос к `/api/v2.2/films/{kp_id}` - timeout=15 секунд
   - Запрос к `/api/v1/staff?filmId={kp_id}` - timeout=15 секунд
   - Если API медленно отвечает, это может занять до 30 секунд!
4. ⚠️ `get_film_current_state()` - несколько запросов к БД - **средне** (~200ms)
5. ❌ **`show_film_info_with_buttons()`** - внутри еще:
   - ❌ **`get_film_current_state()`** - **ДУБЛИРОВАНИЕ!** (уже вызывали выше)
   - ❌ **`get_external_sources(kp_id)`** - еще один запрос к API (timeout=15 секунд)
   - ❌ Для сериалов: `get_series_airing_status()` - еще один запрос к API
   - ⚠️ Несколько запросов к БД для оценок

### Итого:
- **3-4 запроса к внешнему API** (каждый с timeout=15 секунд)
- **Дублирование `get_film_current_state`**
- **Все выполняется синхронно** (один за другим)
- **Нет кэширования** - каждый раз запрашиваем одни и те же данные

## Решение

### 1. Убрать дублирование
- `get_film_current_state` вызывается дважды - один раз в `back_to_film_description`, второй раз в `show_film_info_with_buttons`
- **Решение:** Передавать `current_state` как параметр, не вызывать повторно

### 2. Использовать данные из БД вместо API
- Если фильм уже в базе, не нужно запрашивать API каждый раз
- **Решение:** Использовать данные из БД, запрашивать API только если данных нет

### 3. Сделать запросы к API опциональными
- `get_external_sources` и `get_series_airing_status` можно загружать асинхронно
- **Решение:** Показывать описание сразу, источники и статус загружать потом

### 4. Оптимизировать запросы к БД
- Объединить несколько запросов в один
- Использовать JOIN вместо нескольких SELECT

### 5. Кэширование
- Кэшировать результаты API запросов на короткое время (5-10 минут)
- Кэшировать `get_film_current_state` результаты

## Оптимизированная версия

### Быстрая версия (для фильмов в базе):
1. ✅ Ответ на callback query - < 100ms
2. ✅ Получение данных из БД - ~50ms
3. ✅ `get_film_current_state` (один раз) - ~200ms
4. ✅ Показ описания - ~100ms
5. ⚡ Загрузка источников и статуса в фоне (не блокирует)

**Итого: ~450ms вместо 3-30 секунд!**

### Медленная версия (фильм не в базе):
1. ✅ Ответ на callback query - < 100ms
2. ❌ Запрос к API - 1-3 секунды
3. ✅ Остальное как выше

**Итого: ~1.5-3.5 секунды (все еще приемлемо)**
