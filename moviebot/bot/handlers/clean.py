"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã /clean - –æ—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
"""
import logging
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

from moviebot.database.db_operations import log_request
from moviebot.database.db_connection import get_db_connection, get_db_cursor, db_lock
from moviebot.bot.bot_init import bot as bot_instance, BOT_ID
from moviebot.states import user_clean_state, clean_votes, clean_unwatched_votes
from datetime import datetime, timedelta

logger = logging.getLogger(__name__)
conn = get_db_connection()
cursor = get_db_cursor()


@bot_instance.message_handler(commands=['clean'])
def clean_command(message):
    logger.info(f"[HANDLER] /clean –≤—ã–∑–≤–∞–Ω –æ—Ç {message.from_user.id}")
    username = message.from_user.username or f"user_{message.from_user.id}"
    log_request(message.from_user.id, username, '/clean', message.chat.id)
    
    user_id = message.from_user.id
    chat_id = message.chat.id
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Ç–æ–ª—å–∫–æ —Å –æ–ø—Ü–∏—è–º–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
    markup = InlineKeyboardMarkup(row_width=1)
    markup.add(InlineKeyboardButton("üí• –û–±–Ω—É–ª–∏—Ç—å –±–∞–∑—É —á–∞—Ç–∞", callback_data="clean:chat_db"))
    markup.add(InlineKeyboardButton("üë§ –û–±–Ω—É–ª–∏—Ç—å –±–∞–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="clean:user_db"))
    markup.add(InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã", callback_data="clean:unwatched_movies"))
    markup.add(InlineKeyboardButton("üì• –£–¥–∞–ª–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã —Å –ö–∏–Ω–æ–ø–æ–∏—Å–∫–∞", callback_data="clean:imported_ratings"))
    markup.add(InlineKeyboardButton("üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º—ã, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ", callback_data="clean:clean_imported_movies"))
    
    help_text = (
        "üßπ <b>–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</b>\n\n"
        "<b>üí• –û–±–Ω—É–ª–∏—Ç—å –±–∞–∑—É —á–∞—Ç–∞</b> ‚Äî —É–¥–∞–ª—è–µ—Ç <b>–í–°–ï –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞</b>:\n"
        "‚Ä¢ –í—Å–µ —Ñ–∏–ª—å–º—ã\n"
        "‚Ä¢ –í—Å–µ –æ—Ü–µ–Ω–∫–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
        "‚Ä¢ –í—Å–µ –ø–ª–∞–Ω—ã –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
        "‚Ä¢ –í—Å–µ –±–∏–ª–µ—Ç—ã\n"
        "‚Ä¢ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n\n"
        "<b>üë§ –û–±–Ω—É–ª–∏—Ç—å –±–∞–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b> ‚Äî —É–¥–∞–ª—è–µ—Ç <b>—Ç–æ–ª—å–∫–æ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ —ç—Ç–æ–º —á–∞—Ç–µ</b>:\n"
        "‚Ä¢ –í–∞—à–∏ –æ—Ü–µ–Ω–∫–∏\n"
        "‚Ä¢ –í–∞—à–∏ –ø–ª–∞–Ω—ã –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n"
        "‚Ä¢ –í–∞—à–∏ –±–∏–ª–µ—Ç—ã\n"
        "‚Ä¢ –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        "‚Ä¢ –í–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤–∫–ª—é—á–∞—è —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å)\n\n"
        "<b>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã</b> ‚Äî —É–¥–∞–ª—è–µ—Ç —Ñ–∏–ª—å–º—ã, –∫–æ—Ç–æ—Ä—ã–µ:\n"
        "‚Ä¢ –ù–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏\n"
        "‚Ä¢ –£ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –±–∏–ª–µ—Ç–æ–≤\n"
        "‚Ä¢ –ö–æ—Ç–æ—Ä—ã–µ –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –Ω–∏ –≤ –∫–∞–∫–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö\n\n"
        "<b>üì• –£–¥–∞–ª–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã —Å –ö–∏–Ω–æ–ø–æ–∏—Å–∫–∞</b> ‚Äî —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –≤–∞—à–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –∏–∑ –ö–∏–Ω–æ–ø–æ–∏—Å–∫–∞.\n"
        "‚Ä¢ –£–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ (is_imported = TRUE)\n"
        "‚Ä¢ –í–∞—à–∏ –æ–±—ã—á–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π\n\n"
        "<b>üßπ –£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º—ã, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ</b> ‚Äî —É–¥–∞–ª—è–µ—Ç —Ñ–∏–ª—å–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±–∞–∑—É —Ç–æ–ª—å–∫–æ –∏–∑-–∑–∞ –∏–º–ø–æ—Ä—Ç–∞ –æ—Ü–µ–Ω–æ–∫.\n"
        "‚Ä¢ –£–¥–∞–ª—è—é—Ç—Å—è —Ñ–∏–ª—å–º—ã —Å —Ç–æ–ª—å–∫–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –æ—Ü–µ–Ω–∫–∞–º–∏\n"
        "‚Ä¢ –§–∏–ª—å–º—ã —Å –æ–±—ã—á–Ω—ã–º–∏ –æ—Ü–µ–Ω–∫–∞–º–∏ –∏–ª–∏ –≤ –ø–ª–∞–Ω–∞—Ö –æ—Å—Ç–∞–Ω—É—Ç—Å—è\n\n"
        "<i>–§–∏–ª—å–º—ã –∏ –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.</i>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )
    bot_instance.reply_to(message, help_text, reply_markup=markup, parse_mode='HTML')


def register_clean_handlers(bot):
    """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã /clean"""
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä
    logger.info("–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã /clean –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")

