"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã /list
"""
import logging
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

from moviebot.database.db_operations import log_request
from moviebot.states import user_list_state, list_messages, user_view_film_state, user_plan_state
from moviebot.database.db_connection import get_db_connection, get_db_cursor, db_lock
from moviebot.bot.bot_init import bot as bot_instance
from moviebot.api.kinopoisk_api import extract_movie_info

logger = logging.getLogger(__name__)
conn = get_db_connection()
cursor = get_db_cursor()


def register_list_handlers(bot):
    """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã /list"""
    
    @bot.message_handler(commands=['list'], func=lambda m: not m.reply_to_message)
    def list_movies(message):
        """–ö–æ–º–∞–Ω–¥–∞ /list - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞ –±–µ–∑ —Ä–µ–ø–ª–∞—è"""
        logger.info(f"[HANDLER] /list –≤—ã–∑–≤–∞–Ω –æ—Ç {message.from_user.id}")
        try:
            username = message.from_user.username or f"user_{message.from_user.id}"
            log_request(message.from_user.id, username, '/list', message.chat.id)
            logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /list –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
            chat_id = message.chat.id
            user_id = message.from_user.id
            
            show_list_page(bot, chat_id, user_id, page=1)
            logger.info(f"‚úÖ –û—Ç–≤–µ—Ç –Ω–∞ /list –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ /list: {e}", exc_info=True)
            try:
                bot.reply_to(message, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã /list")
            except:
                pass

    @bot.callback_query_handler(func=lambda call: call.data.startswith("list_page:"))
    def handle_list_page(call):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü –≤ /list"""
        try:
            user_id = call.from_user.id
            page = int(call.data.split(":")[1])
            
            state = user_list_state.get(user_id)
            if not state:
                bot.answer_callback_query(call.id, "–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /list –∑–∞–Ω–æ–≤–æ")
                return
            
            chat_id = state['chat_id']
            show_list_page(bot, chat_id, user_id, page, call.message.message_id)
            bot.answer_callback_query(call.id)
        except Exception as e:
            logger.error(f"[LIST] –û—à–∏–±–∫–∞ –≤ handle_list_page: {e}", exc_info=True)
            try:
                bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã")
            except:
                pass

    @bot.callback_query_handler(func=lambda call: call.data == "noop")
    def handle_noop(call):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (noop)"""
        bot.answer_callback_query(call.id)
    
    @bot.callback_query_handler(func=lambda call: call.data == "plan_from_list")
    def plan_from_list_callback(call):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä' –∏–∑ /list"""
        try:
            user_id = call.from_user.id
            chat_id = call.message.chat.id
            
            logger.info(f"[PLAN FROM LIST] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ö–æ—á–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å–º –∏–∑ /list")
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            user_plan_state[user_id] = {
                'step': 1,
                'chat_id': chat_id
            }
            
            bot_instance.answer_callback_query(call.id, "–ü—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID —Ñ–∏–ª—å–º–∞")
            prompt_msg = bot_instance.send_message(chat_id, "–ü—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID —Ñ–∏–ª—å–º–∞ –≤ –æ—Ç–≤–µ—Ç–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏ –Ω–∞–ø–∏—à–∏—Ç–µ, –≥–¥–µ (–¥–æ–º–∞ –∏–ª–∏ –≤ –∫–∏–Ω–æ) –∏ –∫–æ–≥–¥–∞ –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –µ–≥–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å!")
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –ø—Ä–æ–º–ø—Ç–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            user_plan_state[user_id]['prompt_message_id'] = prompt_msg.message_id
            logger.info(f"[PLAN FROM LIST] –°–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, prompt_message_id={prompt_msg.message_id}")
        except Exception as e:
            logger.error(f"[PLAN FROM LIST] –û—à–∏–±–∫–∞: {e}", exc_info=True)
            try:
                bot_instance.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏", show_alert=True)
            except:
                pass
    
    @bot.callback_query_handler(func=lambda call: call.data == "view_film_from_list")
    def view_film_from_list_callback(call):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ñ–∏–ª—å–º–∞' –∏–∑ /list"""
        try:
            user_id = call.from_user.id
            chat_id = call.message.chat.id
            
            logger.info(f"[VIEW FILM FROM LIST] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ö–æ—á–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ñ–∏–ª—å–º–∞ –∏–∑ /list")
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∏–ª—å–º–∞
            user_view_film_state[user_id] = {
                'chat_id': chat_id
            }
            
            bot_instance.answer_callback_query(call.id, "–ü—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID —Ñ–∏–ª—å–º–∞")
            prompt_msg = bot_instance.send_message(chat_id, "–ü—Ä–∏—à–ª–∏—Ç–µ –≤ –æ—Ç–≤–µ—Ç–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID —Ñ–∏–ª—å–º–∞, —á—å–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å")
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –ø—Ä–æ–º–ø—Ç–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            user_view_film_state[user_id]['prompt_message_id'] = prompt_msg.message_id
            logger.info(f"[VIEW FILM FROM LIST] –°–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, prompt_message_id={prompt_msg.message_id}")
        except Exception as e:
            logger.error(f"[VIEW FILM FROM LIST] –û—à–∏–±–∫–∞: {e}", exc_info=True)
            try:
                bot_instance.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏", show_alert=True)
            except:
                pass


def show_list_page(bot, chat_id, user_id, page=1, message_id=None):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞ —Ñ–∏–ª—å–º–æ–≤"""
    try:
        MOVIES_PER_PAGE = 15
        
        with db_lock:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
            cursor.execute('''
                SELECT DISTINCT m.id, m.kp_id, m.title, m.year, m.genres, m.link 
                FROM movies m
                WHERE m.chat_id = %s 
                  AND m.watched = 0
                ORDER BY m.title
            ''', (chat_id,))
            rows = cursor.fetchall()
        
        if not rows:
            text = "‚è≥ –ù–µ—Ç –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤!"
            markup = InlineKeyboardMarkup()
            markup.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_start_menu"))
            if message_id:
                try:
                    bot.edit_message_text(text, chat_id, message_id, reply_markup=markup)
                except:
                    bot.send_message(chat_id, text, reply_markup=markup)
            else:
                bot.send_message(chat_id, text, reply_markup=markup)
            logger.info(f"‚úÖ –û—Ç–≤–µ—Ç –Ω–∞ /list –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: –Ω–µ—Ç —Ñ–∏–ª—å–º–æ–≤")
            return
        else:
            total_movies = len(rows)
            total_pages = (total_movies + MOVIES_PER_PAGE - 1) // MOVIES_PER_PAGE
            page = max(1, min(page, total_pages))
            
            # –í—ã—á–∏—Å–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω —Ñ–∏–ª—å–º–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            start_idx = (page - 1) * MOVIES_PER_PAGE
            end_idx = min(start_idx + MOVIES_PER_PAGE, total_movies)
            page_movies = rows[start_idx:end_idx]
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            text = f"‚è≥ –ù–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}):\n\n"
            for row in page_movies:
                film_id = row.get('id') if isinstance(row, dict) else row[0]
                kp_id = row.get('kp_id') if isinstance(row, dict) else (row[1] if len(row) > 1 else None)
                title = row.get('title') if isinstance(row, dict) else row[2]
                year = row.get('year') if isinstance(row, dict) else (row[3] if len(row) > 3 else '‚Äî')
                genres = row.get('genres') if isinstance(row, dict) else (row[4] if len(row) > 4 else None)
                link = row.get('link') if isinstance(row, dict) else (row[5] if len(row) > 5 else '')
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤—ã–π –∂–∞–Ω—Ä
                first_genre = None
                if genres and genres != '‚Äî' and genres.strip():
                    genres_list = [g.strip() for g in genres.split(',')]
                    if genres_list:
                        first_genre = genres_list[0]
                
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º kp_id –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ film_id
                movie_id = kp_id or film_id
                genre_str = f" ‚Ä¢ {first_genre}" if first_genre else ""
                text += f"‚Ä¢ <b>{title}</b> ({year}){genre_str} [ID: {movie_id}]\n<a href='{link}'>{link}</a>\n\n"
            
            text += "\n<i>–í –æ—Ç–≤–µ—Ç–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø—Ä–∏—à–ª–∏—Ç–µ ID —Ñ–∏–ª—å–º–æ–≤, –∏ –æ–Ω–∏ –±—É–¥—É—Ç –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ</i>"
            
            # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            markup = InlineKeyboardMarkup()
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            markup.row(
                InlineKeyboardButton("üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä", callback_data="plan_from_list"),
                InlineKeyboardButton("üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ñ–∏–ª—å–º–∞", callback_data="view_film_from_list")
            )
            
            # –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –Ω–µ–º–Ω–æ–≥–æ (<= 20), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
            if total_pages <= 20:
                buttons = []
                for p in range(1, total_pages + 1):
                    label = f"‚Ä¢{p}" if p == page else str(p)
                    buttons.append(InlineKeyboardButton(label, callback_data=f"list_page:{p}"))
                # –†–∞–∑–±–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –ø–æ 10 —à—Ç—É–∫
                for i in range(0, len(buttons), 10):
                    markup.row(*buttons[i:i+10])
            else:
                # –î–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–º–Ω—É—é –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                buttons = []
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—É—â–µ–π
                start_page = max(1, page - 2)
                end_page = min(total_pages, page + 2)
                
                # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∞–ª–µ–∫–æ –æ—Ç –Ω–∞—á–∞–ª–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ "..."
                if start_page > 2:
                    buttons.append(InlineKeyboardButton("1", callback_data="list_page:1"))
                    buttons.append(InlineKeyboardButton("...", callback_data="noop"))
                elif start_page == 2:
                    buttons.append(InlineKeyboardButton("1", callback_data="list_page:1"))
                
                # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—É—â–µ–π
                for p in range(start_page, end_page + 1):
                    label = f"‚Ä¢{p}" if p == page else str(p)
                    buttons.append(InlineKeyboardButton(label, callback_data=f"list_page:{p}"))
                
                # –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∞–ª–µ–∫–æ –æ—Ç –∫–æ–Ω—Ü–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "..." –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                if end_page < total_pages - 1:
                    buttons.append(InlineKeyboardButton("...", callback_data="noop"))
                    buttons.append(InlineKeyboardButton(str(total_pages), callback_data=f"list_page:{total_pages}"))
                elif end_page < total_pages:
                    buttons.append(InlineKeyboardButton(str(total_pages), callback_data=f"list_page:{total_pages}"))
                
                # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –ø–æ 10 –∫–Ω–æ–ø–æ–∫
                for i in range(0, len(buttons), 10):
                    markup.row(*buttons[i:i+10])
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                nav_buttons = []
                if page > 1:
                    nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data=f"list_page:{page-1}"))
                nav_buttons.append(InlineKeyboardButton(f"–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}", callback_data="noop"))
                if page < total_pages:
                    nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä—ë–¥ ‚ñ∂Ô∏è", callback_data=f"list_page:{page+1}"))
                if nav_buttons:
                    markup.row(*nav_buttons)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"
            markup.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_start_menu"))
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            user_list_state[user_id] = {
                'page': page,
                'total_pages': total_pages,
                'chat_id': chat_id
            }
        
        if message_id:
            try:
                bot.edit_message_text(text, chat_id, message_id, reply_markup=markup, parse_mode='HTML', disable_web_page_preview=True)
                # –û–±–Ω–æ–≤–ª—è–µ–º message_id –≤ list_messages –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
                list_messages[message_id] = chat_id
            except Exception as e:
                logger.error(f"[LIST] –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)
                msg = bot.send_message(chat_id, text, reply_markup=markup, parse_mode='HTML', disable_web_page_preview=True)
                list_messages[msg.message_id] = chat_id
        else:
            msg = bot.send_message(chat_id, text, reply_markup=markup, parse_mode='HTML', disable_web_page_preview=True)
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
            list_messages[msg.message_id] = chat_id
            return msg.message_id
    except Exception as e:
        logger.error(f"[LIST] –û—à–∏–±–∫–∞ –≤ show_list_page: {e}", exc_info=True)
        return None


def handle_view_film_reply_internal(message, state):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ñ–∏–ª—å–º–∞"""
    try:
        import re
        from moviebot.bot.bot_init import BOT_ID
        
        user_id = message.from_user.id
        chat_id = state.get('chat_id', message.chat.id)
        text = message.text or ""
        
        logger.info(f"[VIEW FILM REPLY] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç {user_id}, —Ç–µ–∫—Å—Ç: {text[:100]}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è —Ä–µ–ø–ª–∞–µ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
        is_reply = (message.reply_to_message and 
                   message.reply_to_message.from_user and 
                   message.reply_to_message.from_user.id == BOT_ID)
        
        prompt_message_id = state.get('prompt_message_id')
        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ –Ω—É–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞, –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ–≥–æ
        if not is_reply or (prompt_message_id and message.reply_to_message.message_id != prompt_message_id):
            logger.info(f"[VIEW FILM REPLY] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º")
            return
        
        # –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if user_id in user_view_film_state:
            del user_view_film_state[user_id]
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫—É –∏–ª–∏ ID –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        from moviebot.utils.parsing import extract_kp_id_from_text
        
        kp_id = extract_kp_id_from_text(text)
        if not kp_id:
            bot_instance.reply_to(message, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID —Ñ–∏–ª—å–º–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
        if text.strip().startswith('http'):
            link = text.strip()
        else:
            link = f"https://kinopoisk.ru/film/{kp_id}/"
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å–º–µ
        info = extract_movie_info(link)
        if not info:
            bot_instance.reply_to(message, f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å–º–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID: {kp_id}")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–∏–ª—å–º –≤ –±–∞–∑–µ
        with db_lock:
            cursor.execute('SELECT id, title, watched FROM movies WHERE chat_id = %s AND kp_id = %s', (chat_id, kp_id))
            existing = cursor.fetchone()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º existing –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ show_film_info_with_buttons
        if existing:
            film_id = existing.get('id') if isinstance(existing, dict) else existing[0]
            title = existing.get('title') if isinstance(existing, dict) else existing[1]
            watched = existing.get('watched') if isinstance(existing, dict) else existing[2]
            existing_tuple = (film_id, title, watched)
        else:
            existing_tuple = None
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
        from moviebot.bot.handlers.series import show_film_info_with_buttons
        show_film_info_with_buttons(chat_id, user_id, info, link, kp_id, existing_tuple)
        
    except Exception as e:
        logger.error(f"[VIEW FILM REPLY] –û—à–∏–±–∫–∞: {e}", exc_info=True)
        try:
            bot_instance.reply_to(message, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        except:
            pass

