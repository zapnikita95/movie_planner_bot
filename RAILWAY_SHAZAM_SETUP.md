# Настройка КиноШазам на Railway

## Важные моменты для Railway

### 1. Хранение данных (Railway Volume)

КиноШазам требует хранения больших файлов (IMDB база, индекс FAISS). На Railway нужно использовать **Railway Volume** для постоянного хранения.

**Настройка:**
1. В Railway Dashboard создайте Volume для вашего сервиса
2. Подключите Volume к пути `/data`
3. Код автоматически определит наличие `/data` и будет использовать его

**Альтернатива:** Если Volume недоступен, данные будут храниться в локальной папке `data/shazam/`, но они будут удаляться при каждом редеплое.

### 2. Создание индекса

Индекс создается автоматически при первом использовании КиноШазам. Это может занять:
- **Скачивание данных IMDB:** ~500MB (basics, ratings, plots, keywords)
- **Создание индекса:** 5-15 минут в зависимости от мощности сервера
- **Общее время:** 10-20 минут при первом запуске

**Рекомендации:**
- Используйте Railway Volume для ускорения последующих запусков
- Первый запуск лучше делать вручную или через отдельный скрипт
- Можно предварительно создать индекс локально и загрузить на Railway

### 3. Ограничения Railway

**Память:**
- Минимум 2GB RAM рекомендуется для создания индекса
- После создания индекса достаточно 512MB-1GB

**Диск:**
- Индекс FAISS: ~100-500MB (зависит от количества фильмов)
- IMDB данные: ~500MB-1GB
- **Итого:** минимум 2GB свободного места

**CPU:**
- Создание индекса использует все доступные ядра
- Поиск работает быстро даже на слабых CPU

### 4. Переменные окружения

```bash
# Опционально: отключить перевод (если проблемы с памятью)
DISABLE_TRANSLATION=false

# Уже настроено в коде:
TOKENIZERS_PARALLELISM=false
PYTORCH_ENABLE_MPS_FALLBACK=1
```

### 5. Мониторинг

Следите за логами при первом запуске:
- `[SHAZAM] Используется директория данных: /data/shazam` - Volume подключен
- `[SHAZAM] Используется директория данных: .../data/shazam` - локальное хранилище
- `Загружено X фильмов с ключевыми словами` - keywords загружены
- `Индекс создан и сохранён` - готово к использованию

### 6. Troubleshooting

**Проблема: Индекс не сохраняется после редеплоя**
- Решение: Используйте Railway Volume, подключенный к `/data`

**Проблема: Нехватка памяти при создании индекса**
- Решение: Увеличьте RAM до 2GB+ или создайте индекс локально

**Проблема: Медленное создание индекса**
- Решение: Это нормально для первого запуска. Используйте Volume для кэширования

**Проблема: Ошибка при скачивании keywords**
- Решение: Keywords опциональны, система продолжит работу без них

