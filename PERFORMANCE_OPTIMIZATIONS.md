# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è 499 –æ—à–∏–±–æ–∫

## –ü—Ä–æ–±–ª–µ–º–∞

–û–ø–µ—Ä–∞—Ü–∏–∏ "–û—Ç–∫—Ä—ã—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞" –∏–ª–∏ "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–ø–∏—Å–∞–Ω–∏—é" –∑–∞–Ω–∏–º–∞—é—Ç **3-30 —Å–µ–∫—É–Ω–¥**, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ 499 –æ—à–∏–±–∫–∞–º (timeout –æ—Ç Telegram).

## –ü—Ä–∏—á–∏–Ω—ã –º–µ–¥–ª–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã

### 1. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–µ–º—É API (—Å–∞–º–∞—è –±–æ–ª—å—à–∞—è –ø—Ä–æ–±–ª–µ–º–∞!)
- `extract_movie_info()` - –¥–µ–ª–∞–µ—Ç **2 –∑–∞–ø—Ä–æ—Å–∞** –∫ API (films + staff), –∫–∞–∂–¥—ã–π —Å timeout=15 —Å–µ–∫—É–Ω–¥
- `get_external_sources()` - –µ—â–µ **1 –∑–∞–ø—Ä–æ—Å** –∫ API (timeout=15 —Å–µ–∫—É–Ω–¥)
- `get_series_airing_status()` - –µ—â–µ **1 –∑–∞–ø—Ä–æ—Å** –∫ API –¥–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤
- **–ò—Ç–æ–≥–æ: 3-4 –∑–∞–ø—Ä–æ—Å–∞ –∫ API, –∫–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å 1-3 —Å–µ–∫—É–Ω–¥—ã**

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- `get_film_current_state()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–¥–≤–∞–∂–¥—ã**:
  - –û–¥–∏–Ω —Ä–∞–∑ –≤ `back_to_film_description`
  - –í—Ç–æ—Ä–æ–π —Ä–∞–∑ –≤ `show_film_info_with_buttons`
- –≠—Ç–æ –ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î (~200ms –∫–∞–∂–¥—ã–π)

### 3. –í—Å–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- –ó–∞–ø—Ä–æ—Å—ã –∫ API –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ** (–æ–¥–∏–Ω –∑–∞ –¥—Ä—É–≥–∏–º)
- –ï—Å–ª–∏ API –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30+ —Å–µ–∫—É–Ω–¥

### 4. –ù–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
- –î–∞–∂–µ –µ—Å–ª–∏ —Ñ–∏–ª—å–º —É–∂–µ –≤ –±–∞–∑–µ, –≤—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º API –∫–∞–∂–¥—ã–π —Ä–∞–∑
- –≠—Ç–æ –ª–∏—à–Ω–∏–µ 1-3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –∫–∞–∂–¥–æ–º –ø–æ–∫–∞–∑–µ

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –≤–º–µ—Å—Ç–æ API (–¥–ª—è —Ñ–∏–ª—å–º–æ–≤ –≤ –±–∞–∑–µ)
**–§–∞–π–ª:** `moviebot/bot/callbacks/film_callbacks.py`

**–î–æ:**
```python
# –í—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º API
info = extract_movie_info(link)  # 1-3 —Å–µ–∫—É–Ω–¥—ã
```

**–ü–æ—Å–ª–µ:**
```python
# –ï—Å–ª–∏ —Ñ–∏–ª—å–º –≤ –±–∞–∑–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î (–±—ã—Å—Ç—Ä–æ!)
if existing:
    # –ü–æ–ª—É—á–∞–µ–º –∏–∑ –ë–î - ~50ms –≤–º–µ—Å—Ç–æ 1-3 —Å–µ–∫—É–Ω–¥
    info = get_from_db()
else:
    # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤ –±–∞–∑–µ - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º API
    info = extract_movie_info(link)
```

**–≠–∫–æ–Ω–æ–º–∏—è:** 1-3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Ñ–∏–ª—å–º–æ–≤ –≤ –±–∞–∑–µ

### 2. –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `get_film_current_state`
**–§–∞–π–ª:** `moviebot/bot/handlers/series.py`

**–î–æ:**
```python
# –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã
current_state = get_film_current_state(...)  # –≤ back_to_film_description
current_state = get_film_current_state(...)  # –≤ show_film_info_with_buttons
```

**–ü–æ—Å–ª–µ:**
```python
# –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä
if existing is None:
    current_state = get_film_current_state(...)  # —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
else:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ existing, –ø–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ plan_info
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~200ms

### 3. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
**–§–∞–π–ª:** `moviebot/bot/handlers/series.py`

**–î–æ:**
```python
sources = get_external_sources(kp_id)  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–∞ 1-3 —Å–µ–∫—É–Ω–¥—ã
has_sources = bool(sources)
```

**–ü–æ—Å–ª–µ:**
```python
# –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ —Ñ–æ–Ω–µ —Å —Ç–∞–π–º–∞—É—Ç–æ–º 500ms
sources_thread = threading.Thread(target=load_sources_async, daemon=True)
sources_thread.start()
sources_thread.join(timeout=0.5)  # –ñ–¥–µ–º –º–∞–∫—Å–∏–º—É–º 500ms
# –ï—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–∑ –∫–Ω–æ–ø–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
```

**–≠–∫–æ–Ω–æ–º–∏—è:** 0.5-3 —Å–µ–∫—É–Ω–¥—ã (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–∞–∑—É, –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)

### 4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–∏–π
**–§–∞–π–ª:** `moviebot/bot/handlers/series.py`

**–î–æ:**
```python
is_airing, next_episode = get_series_airing_status(kp_id)  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç
text += f"üü¢ –°–µ—Ä–∏–∞–ª –≤—ã—Ö–æ–¥–∏—Ç..."
```

**–ü–æ—Å–ª–µ:**
```python
# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É —Å—Ä–∞–∑—É
text += "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–∏–π..."
# –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ —Ñ–æ–Ω–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
status_thread = threading.Thread(target=load_series_status_async, daemon=True)
status_thread.start()
```

**–≠–∫–æ–Ω–æ–º–∏—è:** 1-3 —Å–µ–∫—É–Ω–¥—ã (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–∞–∑—É, —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)

### 5. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ webhook
**–§–∞–π–ª:** `moviebot/web/web_app.py`

**–î–æ:**
```python
bot.process_new_updates([update])  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç webhook
return '', 200  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
```

**–ü–æ—Å–ª–µ:**
```python
# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
process_thread = threading.Thread(target=process_update_async, daemon=True)
process_thread.start()
return '', 200  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –°–†–ê–ó–£
```

**–≠–∫–æ–Ω–æ–º–∏—è:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç 499 –æ—à–∏–±–∫–∏ - Telegram –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

### –î–ª—è —Ñ–∏–ª—å–º–æ–≤ –≤ –±–∞–∑–µ:
- **–î–æ:** 3-30 —Å–µ–∫—É–Ω–¥ (–∑–∞–ø—Ä–æ—Å—ã –∫ API + –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î)
- **–ü–æ—Å–ª–µ:** ~450ms (–¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î + –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- **–£–ª—É—á—à–µ–Ω–∏–µ:** **–≤ 6-60 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!**

### –î–ª—è —Ñ–∏–ª—å–º–æ–≤ –Ω–µ –≤ –±–∞–∑–µ:
- **–î–æ:** 3-30 —Å–µ–∫—É–Ω–¥
- **–ü–æ—Å–ª–µ:** ~1.5-3.5 —Å–µ–∫—É–Ω–¥—ã (API –≤—Å–µ –µ—â–µ –Ω—É–∂–µ–Ω, –Ω–æ –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
- **–£–ª—É—á—à–µ–Ω–∏–µ:** **–≤ 2-10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–æ–≤
–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ `extract_movie_info` –Ω–∞ 5-10 –º–∏–Ω—É—Ç:
```python
from functools import lru_cache
from datetime import datetime, timedelta

api_cache = {}
cache_ttl = timedelta(minutes=5)

def get_cached_movie_info(kp_id):
    if kp_id in api_cache:
        cached_data, cached_time = api_cache[kp_id]
        if datetime.now() - cached_time < cache_ttl:
            return cached_data
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º API –∏ –∫—ç—à–∏—Ä—É–µ–º
    info = extract_movie_info(...)
    api_cache[kp_id] = (info, datetime.now())
    return info
```

### 2. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API
–ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ API –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:
```python
import concurrent.futures

with concurrent.futures.ThreadPoolExecutor() as executor:
    future_main = executor.submit(get_film_info, kp_id)
    future_staff = executor.submit(get_staff_info, kp_id)
    info = future_main.result()
    staff = future_staff.result()
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–∏–Ω —Å JOIN:
```python
# –í–º–µ—Å—Ç–æ 3 –∑–∞–ø—Ä–æ—Å–æ–≤:
# SELECT ... FROM movies
# SELECT ... FROM plans  
# SELECT ... FROM series_subscriptions

# –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å:
SELECT m.*, p.*, s.subscribed
FROM movies m
LEFT JOIN plans p ON ...
LEFT JOIN series_subscriptions s ON ...
```

## –ò—Ç–æ–≥

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `get_film_current_state`
2. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ë–î –≤–º–µ—Å—Ç–æ API –¥–ª—è —Ñ–∏–ª—å–º–æ–≤ –≤ –±–∞–∑–µ
3. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å–∞
4. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ webhook

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–ø–µ—Ä–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ **10-60 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç 499 –æ—à–∏–±–∫–∏.
