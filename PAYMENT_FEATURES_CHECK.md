# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ

## –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: 5 —è–Ω–≤–∞—Ä—è 2026

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ë–æ—Ç –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ì–¥–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- `moviebot/bot/callbacks/payment_callbacks.py` - –º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç (—Å—Ç—Ä–æ–∫–∏ 395, 491, 518, 522, 606, 623, 677, 714, 809, 883, 954, 1035, 1189, 1326)
- –í—Å–µ –≤—ã–∑–æ–≤—ã `get_active_group_users` –∏—Å–ø–æ–ª—å–∑—É—é—Ç `bot_id=BOT_ID`
- –ë–æ—Ç –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É `if BOT_ID and BOT_ID in members:`

**–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞:**
```python
# –°—Ç—Ä–æ–∫–∞ 395
if BOT_ID and BOT_ID in members:
    members = {uid: uname for uid, uname in members.items() if uid != BOT_ID}

# –°—Ç—Ä–æ–∫–∞ 580
active_users = get_active_group_users(chat_id, bot_id=BOT_ID)

# –°—Ç—Ä–æ–∫–∞ 522
if active_users and BOT_ID:
    active_users = {uid: uname for uid, uname in active_users.items() if uid != BOT_ID}
```

### 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ì–¥–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- `moviebot/bot/callbacks/payment_callbacks.py` - —Å—Ç—Ä–æ–∫–∞ 654
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `payment:add_member:` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

**–ö–æ–¥:**
```python
if action.startswith("add_member:"):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
    subscription_id = int(action.split(":")[1])
    member_user_id = int(action.split(":")[2])
    # ... –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∏ –ø—Ä–∞–≤ –≤–ª–∞–¥–µ–ª—å—Ü–∞ ...
    add_subscription_member(subscription_id, member_user_id, username)
```

## ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢ –ü–†–û–í–ï–†–ö–ò/–î–û–†–ê–ë–û–¢–ö–ò

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ù–ï –ù–ê–ô–î–ï–ù–û –í –ö–û–î–ï**

**–ì–¥–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ `create_subscription()` –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `successful_payment` (–¥–ª—è Stars)
- –í webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ YooKassa –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- `moviebot.py` (—Å—Ç—Ä–æ–∫–∏ 24419-24429) - –ø–æ—Å–ª–µ `create_subscription()` –Ω–µ—Ç –≤—ã–∑–æ–≤–∞ `add_subscription_member()`
- `moviebot/web/web_app.py` (—Å—Ç—Ä–æ–∫–∏ 273-374) - –ø–æ—Å–ª–µ `create_subscription()` –Ω–µ—Ç –≤—ã–∑–æ–≤–∞ `add_subscription_member()`
- `moviebot/database/db_operations.py` (—Å—Ç—Ä–æ–∫–∏ 706-779) - —Ñ—É–Ω–∫—Ü–∏—è `create_subscription()` –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–í—ã–≤–æ–¥:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û** –Ω–∏ –≤ —Å—Ç–∞—Ä–æ–º, –Ω–∏ –≤ –Ω–æ–≤–æ–º –∫–æ–¥–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:
```python
# –ü–æ—Å–ª–µ create_subscription() –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
if subscription_type == 'group' and subscription_id:
    from moviebot.database.db_operations import add_subscription_member
    username = message.from_user.username or f"user_{user_id}"
    add_subscription_member(subscription_id, user_id, username)
```

### 4. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ß–ê–°–¢–ò–ß–ù–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ì–¥–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- `moviebot/web/web_app.py` (—Å—Ç—Ä–æ–∫–∏ 659-666) - –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", –µ—Å–ª–∏ `active_count > group_size and members_count < group_size`
- –ù–û: –Ω–µ—Ç –ª–æ–≥–∏–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π —Å –µ–≥–æ –Ω–∏–∫–æ–º

**–ß—Ç–æ –µ—Å—Ç—å:**
```python
# –°—Ç—Ä–æ–∫–∞ 660-666 –≤ web_app.py
if group_size and active_count > group_size and members_count < group_size:
    group_text += f"\n\n‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b>\n"
    group_text += f"–í –≥—Ä—É–ø–ø–µ <b>{active_count}</b> –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∞ –ø–æ–¥–ø–∏—Å–∫–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –Ω–∞ <b>{group_size}</b>.\n"
    group_text += f"–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏:"
    
    markup = InlineKeyboardMarkup(row_width=1)
    markup.add(InlineKeyboardButton("üë• –í—ã–±—Ä–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data=f"payment:select_members:{subscription_id}"))
```

**–ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- –õ–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π —Å –µ–≥–æ –Ω–∏–∫–æ–º (–µ—Å–ª–∏ –≤ –≥—Ä—É–ø–ø–µ –µ—Å—Ç—å –µ—â–µ –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –∫—Ä–æ–º–µ –±–æ—Ç–∞ –∏ –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ)
- –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: "–µ—Å–ª–∏ –≤ –≥—Ä—É–ø–ø–µ –µ—Å—Ç—å –µ—â–µ –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫ (–∫—Ä–æ–º–µ –±–æ—Ç–∞ –∏ –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ) –∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ –≤ –ø–æ–¥–ø–∏—Å–∫–µ, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ —Å –µ–≥–æ –Ω–∏–∫–æ–º"

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫—É:
```python
# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ
if subscription_type == 'group' and subscription_id:
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∏—Å–∫–ª—é—á–∞—è –±–æ—Ç–∞ –∏ –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ)
    active_users = get_active_group_users(chat_id, bot_id=BOT_ID)
    if user_id in active_users:
        del active_users[user_id]  # –ò—Å–∫–ª—é—á–∞–µ–º –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –µ—â–µ –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ –≤ –ø–æ–¥–ø–∏—Å–∫–µ
    if len(active_users) == 1 and members_count < group_size:
        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫–Ω–æ–ø–∫—É —Å –Ω–∏–∫–æ–º —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        member_id, member_username = list(active_users.items())[0]
        markup.add(InlineKeyboardButton(
            f"‚ûï –î–æ–±–∞–≤–∏—Ç—å @{member_username}",
            callback_data=f"payment:add_member:{member_id}:{subscription_id}"
        ))
    elif len(active_users) > 1 and members_count < group_size:
        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
        markup.add(InlineKeyboardButton(
            "üë• –í—ã–±—Ä–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤",
            callback_data=f"payment:select_members:{subscription_id}"
        ))
```

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `successful_payment` (–¥–ª—è Stars)
   - –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤ webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ YooKassa
   - –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ `add_subscription_member(subscription_id, user_id, username)` —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `create_subscription()`

2. **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞:**
   - –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∏—Å–∫–ª—é—á–∞—è –±–æ—Ç–∞ –∏ –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ)
   - –ï—Å–ª–∏ –µ—Å—Ç—å –µ—â–µ –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ –≤ –ø–æ–¥–ø–∏—Å–∫–µ, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å –µ–≥–æ –Ω–∏–∫–æ–º
   - –ï—Å–ª–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"

## üîç –ì–¥–µ –∏—Å–∫–∞—Ç—å –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –∫–æ–¥–µ

–ï—Å–ª–∏ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –±—ã–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –Ω–µ–¥–∞–≤–Ω–æ, –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –≤:
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `successful_payment` –≤ `moviebot.py` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 24429)
- Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ YooKassa –≤ `moviebot/web/web_app.py` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 374)
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `payment:active:group` –≤ `moviebot.py` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 18000-18500)

## üìù –ò—Ç–æ–≥

- ‚úÖ –ë–æ—Ç –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ - **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**
- ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `payment:add_member` - **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û**
- ‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–ª–∞—Ç–∏–≤—à–µ–≥–æ - **–ù–ï –ù–ê–ô–î–ï–ù–û** (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
- ‚ö†Ô∏è –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ - **–ß–ê–°–¢–ò–ß–ù–û** (–µ—Å—Ç—å –æ–±—â–∞—è –∫–Ω–æ–ø–∫–∞, –Ω–æ –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞)

