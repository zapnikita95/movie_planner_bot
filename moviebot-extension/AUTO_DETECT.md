# Автоматическое определение фильма

## Что было реализовано:

### ✅ Автоматическая загрузка при открытии popup

При каждом открытии popup расширения:

1. **Получает текущую активную вкладку**
2. **Определяет тип страницы:**
   - Кинопоиск (`kinopoisk.ru/film/*` или `kinopoisk.ru/series/*`)
   - IMDb (`imdb.com/title/*`)
   - Letterboxd (`letterboxd.com/film/*`)

3. **Автоматически загружает информацию о фильме:**
   - Для Кинопоиска: извлекает `kp_id` из URL → загружает информацию
   - Для IMDb: извлекает `imdb_id` из URL → конвертирует в `kp_id` → загружает информацию
   - Для Letterboxd: извлекает `imdb_id` через content script → конвертирует в `kp_id` → загружает информацию

### ✅ Обновление при каждом открытии

- Popup **не кэширует** старое состояние
- При каждом открытии получает **свежую информацию** о текущей вкладке
- Показывает индикатор "Загрузка..." во время загрузки
- Очищает предыдущее состояние перед загрузкой нового

### ✅ Интеграция с content scripts

Content scripts теперь могут отвечать на запросы от popup:

- `content-kp.js` - отвечает на `get_kp_id`
- `content-imdb.js` - отвечает на `get_imdb_id`
- `content-letterboxd.js` - отвечает на `get_imdb_id`

## Как это работает:

1. Пользователь открывает страницу фильма (Кинопоиск/IMDb/Letterboxd)
2. Пользователь кликает на иконку расширения
3. Popup открывается и автоматически:
   - Получает URL текущей вкладки
   - Определяет тип страницы
   - Запрашивает ID у content script (если нужно)
   - Загружает информацию о фильме через API
   - Показывает русское название и ссылку на Кинопоиск

## Примеры:

### Кинопоиск:
- URL: `https://www.kinopoisk.ru/film/123456/`
- Извлекается: `kp_id = 123456`
- Загружается: информация о фильме с русским названием

### IMDb:
- URL: `https://www.imdb.com/title/tt1234567/`
- Извлекается: `imdb_id = tt1234567`
- Конвертируется: `imdb_id → kp_id` через API
- Загружается: информация о фильме с русским названием и ссылкой на Кинопоиск

### Letterboxd:
- URL: `https://letterboxd.com/film/marty-supreme/`
- Content script извлекает: `imdb_id` из ссылок на странице
- Конвертируется: `imdb_id → kp_id` через API
- Загружается: информация о фильме с русским названием и ссылкой на Кинопоиск

## Технические детали:

- Использует `chrome.tabs.query()` для получения текущей вкладки
- Использует `chrome.tabs.sendMessage()` для запроса данных у content scripts
- Обрабатывает ошибки и показывает понятные сообщения
- Не кэширует состояние между открытиями popup
