# Инструкция по настройке расширения

## Что было сделано

✅ Создана полная структура браузерного расширения
✅ Добавлена команда `/code` в бота
✅ Созданы API endpoints для работы расширения
✅ Реализован парсинг imdb_id с Letterboxd и IMDb
✅ Реализована конвертация imdb_id в kp_id
✅ Добавлено определение типа (фильм/сериал) и формирование правильных ссылок
✅ Создан UI для планирования просмотра
✅ Добавлены кнопки на сайты с билетами
✅ Все операции БД без db_lock (как просили)

## Что нужно настроить

### 1. URL API в расширении

В файлах `background.js` и `popup.js` замените:
```javascript
const API_BASE_URL = 'https://your-railway-app.up.railway.app';
```
на ваш реальный URL Railway приложения.

### 2. Иконки расширения

Создайте иконки в папке `icons/`:
- `icon16.png` (16x16 пикселей)
- `icon48.png` (48x48 пикселей)  
- `icon128.png` (128x128 пикселей)

Можно использовать любой графический редактор или онлайн-генератор иконок.

### 3. Проверка работы

1. Запустите бота
2. Выполните команду `/code` в боте
3. Установите расширение в браузер
4. Откройте расширение и введите код
5. Попробуйте открыть страницу фильма на Letterboxd или IMDb

## Структура файлов

```
moviebot-extension/
├── manifest.json          # Манифест расширения
├── background.js          # Service Worker
├── popup.html             # HTML popup
├── popup.css              # Стили popup
├── popup.js               # Логика popup
├── content/
│   ├── letterboxd.js      # Парсинг Letterboxd
│   ├── imdb.js            # Парсинг IMDb
│   └── tickets.js         # Обработка сайтов с билетами
├── icons/                 # Иконки расширения
└── README.md              # Документация
```

## API Endpoints

Расширение использует следующие endpoints:

- `GET /api/extension/verify?code=XXX` - проверка кода авторизации
- `GET /api/extension/film-info?kp_id=XXX&chat_id=XXX` - информация о фильме
- `GET /api/extension/film-info?imdb_id=XXX&chat_id=XXX` - информация о фильме по imdb_id
- `POST /api/extension/add-film` - добавление фильма в базу
- `POST /api/extension/create-plan` - создание плана просмотра

Все endpoints уже добавлены в `web_app.py`.

## Особенности реализации

1. **Без db_lock**: Все операции с БД в API endpoints выполняются без db_lock (как просили)
2. **Определение типа**: Автоматически определяется тип (фильм/сериал) через API Кинопоиска
3. **Правильные ссылки**: Формируются правильные ссылки на Кинопоиск (`/film/` или `/series/`)
4. **Кнопки на сайтах**: На сайтах с билетами автоматически появляется кнопка "Отправить в Movie Planner"

## Тестирование

После настройки проверьте:

1. ✅ Команда `/code` в боте генерирует код
2. ✅ Код можно ввести в расширении и привязать аккаунт
3. ✅ На Letterboxd определяется imdb_id
4. ✅ На IMDb определяется imdb_id
5. ✅ Фильм можно добавить в базу
6. ✅ Можно создать план просмотра
7. ✅ На сайтах с билетами появляется кнопка

## Возможные проблемы

1. **CORS ошибки**: Убедитесь, что Railway приложение разрешает запросы с вашего домена
2. **Код не работает**: Проверьте, что таблица `extension_links` создана в БД
3. **Фильм не находится**: Проверьте, что API Кинопоиска работает и токен валиден
